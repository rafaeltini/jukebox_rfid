<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title data-i18n-key="title">üé∂ Jukebox RFID MP3</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="header">
        <h1 data-i18n-key="title">üé∂ Jukebox RFID MP3</h1>
        <div class="lang-switcher">
            <span id="lang-pt">üáßüá∑</span>
            <span id="lang-en">üá∫üá∏</span>
        </div>
    </div>

    <nav class="navigation">
        <a href="#" class="nav-link active" data-page="player" data-i18n-key="nav_player">Player</a>
        <a href="#" class="nav-link" data-page="library" data-i18n-key="nav_library">Biblioteca</a>
        <a href="#" class="nav-link" data-page="tags" data-i18n-key="nav_tags">Tags</a>
    </nav>

    <main id="page-player" class="page active">
        <div class="player-container">
            <h2 data-i18n-key="player_title">Player</h2>
            <div id="track-info" data-i18n-key="nothing_playing">Sil√™ncio...</div>
            <div class="controls">
                <button id="play-pause-btn">‚ñ∂Ô∏è</button>
                <div class="volume-control">
                    <label for="volume">üîä</label>
                    <input type="range" id="volume" min="0" max="100" value="50">
                </div>
            </div>
        </div>

        <div class="upload-container">
            <h2 data-i18n-key="upload_title">Adicionar Nova M√∫sica</h2>
            <div id="drop-zone">
                <p data-i18n-key="drop_zone_text">Arraste um arquivo MP3 aqui ou clique para selecionar</p>
                <input type="file" id="file-input" accept=".mp3" style="display: none;">
            </div>
            <div id="upload-status"></div>
        </div>

        <div class="rfid-test-container">
            <h2 data-i18n-key="rfid_test_title">Teste de Cart√£o RFID</h2>
            <div id="rfid-status" data-i18n-key="rfid_waiting">Aguardando um cart√£o...</div>
        </div>
    </main>

    <main id="page-library" class="page" style="display: none;">
        <div class="library-container">
            <h2 data-i18n-key="library_title">Biblioteca de M√∫sicas</h2>
            <ul id="song-list">
                <!-- A lista de m√∫sicas ser√° inserida aqui pelo JavaScript -->
            </ul>
        </div>
    </main>

    <main id="page-tags" class="page" style="display: none;">
        <div class="tags-container">
            <h2 data-i18n-key="tags_title">Gerenciamento de Tags</h2>
            <div id="tag-list">
                <!-- A lista de associa√ß√µes de tags ser√° inserida aqui pelo JavaScript -->
            </div>
        </div>
    </main>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        // --- Seletores de Elementos ---
        const ui = {
            playPauseBtn: document.getElementById('play-pause-btn'),
            volumeSlider: document.getElementById('volume'),
            trackInfo: document.getElementById('track-info'),
            dropZone: document.getElementById('drop-zone'),
            fileInput: document.getElementById('file-input'),
            uploadStatus: document.getElementById('upload-status'),
            langPtBtn: document.getElementById('lang-pt'),
            langEnBtn: document.getElementById('lang-en'),
            rfidStatus: document.getElementById('rfid-status')
        };

        // --- Estado da Aplica√ß√£o ---
        let translations = {};
        let currentLang = localStorage.getItem('jukeboxLang') || 'pt';

        // --- M√≥dulo da API ---
        const api = {
            getTranslations: () => fetch('/api/translations').then(res => res.json()),
            getStatus: () => fetch('/api/status').then(res => res.json()),
            getLibrary: () => fetch('/api/library').then(res => res.json()),
            deleteAssociation: (tagId) => fetch(`/api/association/${tagId}`, { method: 'DELETE' }).then(res => res.json()),
            togglePlayPause: () => fetch('/api/play_pause', { method: 'POST' }).then(res => res.json()),
            playSong: (filename) => fetch(`/api/play/${filename}`, { method: 'POST' }).then(res => res.json()),
            setVolume: (level) => fetch('/api/volume', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ level })
            }).then(res => res.json()),
            uploadFile: (file) => {
                const formData = new FormData();
                formData.append('file', file);
                return fetch('/api/upload', { method: 'POST', body: formData })
                    .then(res => res.json());
            }
        };

        // --- L√≥gica de Internacionaliza√ß√£o (i18n) ---
        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('jukeboxLang', lang);

            document.documentElement.lang = lang;
            ui.langPtBtn.classList.toggle('active', lang === 'pt');
            ui.langEnBtn.classList.toggle('active', lang === 'en');

            document.querySelectorAll('[data-i18n-key]').forEach(el => {
                const key = el.getAttribute('data-i18n-key');
                if (translations[lang] && translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });
            // Atualiza a UI do player com o novo idioma
            api.getStatus().then(updatePlayerUI);
        }

        // --- L√≥gica da UI do Player ---
        function updatePlayerUI(status) {
            const trackText = status.current_song
                ? (translations[currentLang]?.now_playing || 'Now playing: ') + status.current_song
                : (translations[currentLang]?.nothing_playing || 'Silence...');
            ui.trackInfo.textContent = trackText;

            ui.playPauseBtn.textContent = (status.is_playing && !status.is_paused) ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';
            ui.volumeSlider.value = status.volume * 100;
        }

        // --- L√≥gica de Upload ---
        function handleFileUpload(file) {
            if (!file || file.type !== 'audio/mpeg') {
                ui.uploadStatus.textContent = translations[currentLang]?.upload_status_invalid || 'Invalid file.';
                return;
            }
            ui.uploadStatus.textContent = (translations[currentLang]?.upload_status_uploading || 'Uploading ') + file.name + '...';
            api.uploadFile(file).then(response => {
                if (response.status === 'success') {
                    ui.uploadStatus.textContent = `‚úÖ ${file.name} ` + (translations[currentLang]?.upload_status_success || 'saved. Scan a card to associate.');
                } else {
                    ui.uploadStatus.textContent = `‚ùå ` + (translations[currentLang]?.upload_status_error || 'Upload error.');
                }
                setTimeout(() => { api.getStatus().then(updatePlayerUI); }, 1500);
            }).catch(err => {
                ui.uploadStatus.textContent = '‚ùå ' + (translations[currentLang]?.upload_status_error || 'Upload error.');
                console.error(err);
            });
        }

        // --- L√≥gica de Renderiza√ß√£o das P√°ginas ---
        function renderLibrary(library) {
            const songList = document.getElementById('song-list');
            songList.innerHTML = ''; // Limpa a lista antiga

            if (!library.songs || library.songs.length === 0) {
                songList.innerHTML = `<li>${translations[currentLang]?.library_empty || 'Nenhuma m√∫sica encontrada.'}</li>`;
                return;
            }

            library.songs.forEach(song => {
                const li = document.createElement('li');
                li.textContent = song;

                const playButton = document.createElement('button');
                playButton.textContent = '‚ñ∂Ô∏è';
                playButton.className = 'play-song-btn';
                playButton.onclick = () => {
                    api.playSong(song).then(response => {
                        console.log(response);
                        // Opcional: atualizar o status do player imediatamente
                        setTimeout(() => api.getStatus().then(updatePlayerUI), 500);
                    });
                };

                li.appendChild(playButton);
                songList.appendChild(li);
            });
        }

        function renderTags(library) {
            const tagList = document.getElementById('tag-list');
            tagList.innerHTML = ''; // Limpa a lista antiga

            const associations = library.associations;
            if (!associations || Object.keys(associations).length === 0) {
                tagList.innerHTML = `<p>${translations[currentLang]?.tags_empty || 'Nenhuma tag associada encontrada.'}</p>`;
                return;
            }

            const table = document.createElement('table');
            table.className = 'tag-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>${translations[currentLang]?.table_header_tag || 'Cart√£o RFID (UID)'}</th>
                        <th>${translations[currentLang]?.table_header_song || 'M√∫sica Associada'}</th>
                        <th>${translations[currentLang]?.table_header_actions || 'A√ß√µes'}</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            `;
            const tbody = table.querySelector('tbody');

            for (const tagId in associations) {
                const song = associations[tagId];
                const row = document.createElement('tr');

                const cellTag = document.createElement('td');
                cellTag.textContent = tagId;

                const cellSong = document.createElement('td');
                cellSong.textContent = song;

                const cellActions = document.createElement('td');
                const deleteButton = document.createElement('button');
                deleteButton.textContent = translations[currentLang]?.btn_delete || 'Deletar';
                deleteButton.className = 'delete-btn';
                deleteButton.onclick = () => {
                    if (confirm((translations[currentLang]?.confirm_delete || 'Tem certeza que deseja deletar a associa√ß√£o para a tag') + ` ${tagId}?`)) {
                        api.deleteAssociation(tagId).then(response => {
                            console.log(response);
                            // Recarrega a lista de tags para mostrar a mudan√ßa
                            api.getLibrary().then(renderTags);
                        });
                    }
                };
                cellActions.appendChild(deleteButton);

                row.appendChild(cellTag);
                row.appendChild(cellSong);
                row.appendChild(cellActions);
                tbody.appendChild(row);
            }

            tagList.appendChild(table);
        }

        // --- L√≥gica de Navega√ß√£o ---
        function setupNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            const pages = document.querySelectorAll('.page');

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageId = link.getAttribute('data-page');

                    pages.forEach(page => page.classList.remove('active'));
                    navLinks.forEach(navLink => navLink.classList.remove('active'));

                    document.getElementById(`page-${pageId}`).classList.add('active');
                    link.classList.add('active');

                    // Carrega o conte√∫do da p√°gina clicada
                    if (pageId === 'library' || pageId === 'tags') {
                        api.getLibrary().then(library => {
                            if (pageId === 'library') {
                                renderLibrary(library);
                            }
                            if (pageId === 'tags') {
                                renderTags(library);
                            }
                        });
                    }
                });
            });
        }

        // --- L√≥gica do WebSocket ---
        function setupSocketListeners() {
            const socket = io();

            socket.on('connect', () => {
                console.log('Conectado ao servidor WebSocket! / Connected to WebSocket server!');
            });

            socket.on('rfid_scan', (data) => {
                console.log('Evento rfid_scan recebido:', data);
                const statusText = data.associated
                    ? (translations[currentLang]?.rfid_associated || 'Associated')
                    : (translations[currentLang]?.rfid_not_associated || 'Not Associated');

                ui.rfidStatus.innerHTML = `<strong>UID:</strong> ${data.uid}<br><strong>Status:</strong> ${statusText}`;
            });
        }

        // --- Event Listeners ---
        ui.playPauseBtn.addEventListener('click', () => api.togglePlayPause().then(updatePlayerUI));
        ui.volumeSlider.addEventListener('input', (e) => api.setVolume(e.target.value));
        ui.langPtBtn.addEventListener('click', () => setLanguage('pt'));
        ui.langEnBtn.addEventListener('click', () => setLanguage('en'));
        ui.dropZone.addEventListener('click', () => ui.fileInput.click());
        ui.fileInput.addEventListener('change', (e) => handleFileUpload(e.target.files[0]));

        // Drag & Drop listeners
        ['dragover', 'dragleave', 'drop'].forEach(eventName => {
            ui.dropZone.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
        });
        ui.dropZone.addEventListener('dragover', () => ui.dropZone.classList.add('active'));
        ui.dropZone.addEventListener('dragleave', () => ui.dropZone.classList.remove('active'));
        ui.dropZone.addEventListener('drop', (e) => {
            ui.dropZone.classList.remove('active');
            handleFileUpload(e.dataTransfer.files[0]);
        });

        // --- Inicializa√ß√£o ---
        async function initialize() {
            try {
                translations = await api.getTranslations();
                setLanguage(currentLang);
                setupNavigation();
                setupSocketListeners(); // Configura os listeners do WebSocket
                setInterval(() => api.getStatus().then(updatePlayerUI), 3000);
            } catch (error) {
                console.error("Falha ao inicializar a aplica√ß√£o:", error);
                document.body.innerHTML = "<h1>Erro ao carregar a Jukebox. Verifique o console.</h1>";
            }
        }

        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>