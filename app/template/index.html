<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title data-i18n-key="title">🎶 Jukebox RFID MP3</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="header">
        <h1 data-i18n-key="title">🎶 Jukebox RFID MP3</h1>
        <div class="lang-switcher">
            <span id="lang-pt">🇧🇷</span>
            <span id="lang-en">🇺🇸</span>
        </div>
    </div>

    <div class="player-container">
        <h2 data-i18n-key="player_title">Player</h2>
        <div id="track-info" data-i18n-key="nothing_playing">Silêncio...</div>
        <div class="controls">
            <button id="play-pause-btn">▶️</button>
            <div class="volume-control">
                <label for="volume">🔊</label>
                <input type="range" id="volume" min="0" max="100" value="50">
            </div>
        </div>
    </div>

    <div class="upload-container">
        <h2 data-i18n-key="upload_title">Adicionar Nova Música</h2>
        <div id="drop-zone">
            <p data-i18n-key="drop_zone_text">Arraste um arquivo MP3 aqui ou clique para selecionar</p>
            <input type="file" id="file-input" accept=".mp3" style="display: none;">
        </div>
        <div id="upload-status"></div>
    </div>

    <div class="rfid-test-container">
        <h2 data-i18n-key="rfid_test_title">Teste de Cartão RFID</h2>
        <div id="rfid-status" data-i18n-key="rfid_waiting">Aguardando um cartão...</div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        // --- Seletores de Elementos ---
        const ui = {
            playPauseBtn: document.getElementById('play-pause-btn'),
            volumeSlider: document.getElementById('volume'),
            trackInfo: document.getElementById('track-info'),
            dropZone: document.getElementById('drop-zone'),
            fileInput: document.getElementById('file-input'),
            uploadStatus: document.getElementById('upload-status'),
            langPtBtn: document.getElementById('lang-pt'),
            langEnBtn: document.getElementById('lang-en'),
            rfidStatus: document.getElementById('rfid-status')
        };

        // --- Estado da Aplicação ---
        let translations = {};
        let currentLang = localStorage.getItem('jukeboxLang') || 'pt';

        // --- Módulo da API ---
        const api = {
            getTranslations: () => fetch('/api/translations').then(res => res.json()),
            getStatus: () => fetch('/api/status').then(res => res.json()),
            togglePlayPause: () => fetch('/api/play_pause', { method: 'POST' }).then(res => res.json()),
            setVolume: (level) => fetch('/api/volume', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ level })
            }).then(res => res.json()),
            uploadFile: (file) => {
                const formData = new FormData();
                formData.append('file', file);
                return fetch('/api/upload', { method: 'POST', body: formData })
                    .then(res => res.json());
            }
        };

        // --- Lógica de Internacionalização (i18n) ---
        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('jukeboxLang', lang);

            document.documentElement.lang = lang;
            ui.langPtBtn.classList.toggle('active', lang === 'pt');
            ui.langEnBtn.classList.toggle('active', lang === 'en');

            document.querySelectorAll('[data-i18n-key]').forEach(el => {
                const key = el.getAttribute('data-i18n-key');
                if (translations[lang] && translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });
            // Atualiza a UI do player com o novo idioma
            api.getStatus().then(updatePlayerUI);
        }

        // --- Lógica da UI do Player ---
        function updatePlayerUI(status) {
            const trackText = status.current_song
                ? (translations[currentLang]?.now_playing || 'Now playing: ') + status.current_song
                : (translations[currentLang]?.nothing_playing || 'Silence...');
            ui.trackInfo.textContent = trackText;

            ui.playPauseBtn.textContent = (status.is_playing && !status.is_paused) ? '⏸️' : '▶️';
            ui.volumeSlider.value = status.volume * 100;
        }

        // --- Lógica de Upload ---
        function handleFileUpload(file) {
            if (!file || file.type !== 'audio/mpeg') {
                ui.uploadStatus.textContent = translations[currentLang]?.upload_status_invalid || 'Invalid file.';
                return;
            }
            ui.uploadStatus.textContent = (translations[currentLang]?.upload_status_uploading || 'Uploading ') + file.name + '...';
            api.uploadFile(file).then(response => {
                if (response.status === 'success') {
                    ui.uploadStatus.textContent = `✅ ${file.name} ` + (translations[currentLang]?.upload_status_success || 'saved. Scan a card to associate.');
                } else {
                    ui.uploadStatus.textContent = `❌ ` + (translations[currentLang]?.upload_status_error || 'Upload error.');
                }
                setTimeout(api.getStatus, 1500).then(updatePlayerUI);
            }).catch(err => {
                ui.uploadStatus.textContent = '❌ ' + (translations[currentLang]?.upload_status_error || 'Upload error.');
                console.error(err);
            });
        }

        // --- Lógica do WebSocket ---
        function setupSocketListeners() {
            const socket = io();

            socket.on('connect', () => {
                console.log('Conectado ao servidor WebSocket! / Connected to WebSocket server!');
            });

            socket.on('rfid_scan', (data) => {
                console.log('Evento rfid_scan recebido:', data);
                const statusText = data.associated
                    ? (translations[currentLang]?.rfid_associated || 'Associated')
                    : (translations[currentLang]?.rfid_not_associated || 'Not Associated');

                ui.rfidStatus.innerHTML = `<strong>UID:</strong> ${data.uid}<br><strong>Status:</strong> ${statusText}`;
            });
        }

        // --- Event Listeners ---
        ui.playPauseBtn.addEventListener('click', () => api.togglePlayPause().then(updatePlayerUI));
        ui.volumeSlider.addEventListener('input', (e) => api.setVolume(e.target.value));
        ui.langPtBtn.addEventListener('click', () => setLanguage('pt'));
        ui.langEnBtn.addEventListener('click', () => setLanguage('en'));
        ui.dropZone.addEventListener('click', () => ui.fileInput.click());
        ui.fileInput.addEventListener('change', (e) => handleFileUpload(e.target.files[0]));

        // Drag & Drop listeners
        ['dragover', 'dragleave', 'drop'].forEach(eventName => {
            ui.dropZone.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
        });
        ui.dropZone.addEventListener('dragover', () => ui.dropZone.classList.add('active'));
        ui.dropZone.addEventListener('dragleave', () => ui.dropZone.classList.remove('active'));
        ui.dropZone.addEventListener('drop', (e) => {
            ui.dropZone.classList.remove('active');
            handleFileUpload(e.dataTransfer.files[0]);
        });

        // --- Inicialização ---
        async function initialize() {
            try {
                translations = await api.getTranslations();
                setLanguage(currentLang);
                setupSocketListeners(); // Configura os listeners do WebSocket
                setInterval(() => api.getStatus().then(updatePlayerUI), 3000);
            } catch (error) {
                console.error("Falha ao inicializar a aplicação:", error);
                document.body.innerHTML = "<h1>Erro ao carregar a Jukebox. Verifique o console.</h1>";
            }
        }

        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>